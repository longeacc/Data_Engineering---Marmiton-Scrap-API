services:
  # 1. Base de données (Stockage Persistant)
  mongodb:
    image: mongo:latest
    container_name: marmiton_mongo
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - data_net

  # 2. API (Backend FastAPI)
  api:
    build: ./api
    container_name: marmiton_api
    restart: unless-stopped
    ports:
      - "8000:8000"
    depends_on:
      - mongodb
    networks:
      - data_net
    environment:
      - MONGO_HOST=mongodb

  # 3. Web App (Dashboard & API like)
  webapp:
    build: ./app
    container_name: marmiton_app
    restart: unless-stopped
    ports:
      - "8501:8501"
    depends_on:
      - api
    networks:
      - data_net
    environment:
      - API_URL=http://api:8000

  # 5. Loader (Import initial des données JSON)
  loader:
    build: ./loader
    container_name: marmiton_loader
    volumes:
      # On monte le fichier JSON local dans le conteneur à l'adresse /data/dataset.json
      - ./dataset_marmiton_final.json:/data/dataset.json
    depends_on:
      - mongodb
    networks:
      - data_net
    environment:
      - MONGO_HOST=mongodb

volumes:
  mongodb_data:

networks:
  data_net:
    driver: bridge
